<!doctype html>
<html lang="fr">

	<head>
		<title>vma1991.net</title>

		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		<style type="text/css">
			body {
				font-family:monospace;
				display:grid;
				grid-template-columns: minmax(auto, 1200px);
				grid-template-rows:auto auto auto;
			}

			@media screen and (max-width: 760px) {
				.page {
					display:grid;
					grid-template-columns:1fr;
					grid-template-rows:auto;
				}
			}

			@media screen and (min-width: 761px) {
				.page {
					display:grid;
					grid-template-columns:1fr 1fr 1fr;
					grid-template-rows:auto;
				}
			}
			
			.page div {
				margin:2px;
				padding:2px;
			}

			h2 {
				font-family:serif;
			}

			div#loading {
				width:100%;
				height:100%;
				top:0;
				left:0;
				position:absolute;
				z-index:10;
				background-color:white;
				box-sizing:border-box;
				padding:2px;
			}
        </style>

		<script src="https://cdn.plot.ly/plotly-2.12.1.min.js"></script>
	</head>

	<body>
		<div id="loading">Chargement... &#9203;</div>		

			<picture class="logo">
				<source srcset="grattoir-350.gif" media="(max-width:760px)">
				<img src="grattoir-750.gif" alt="Le Grattoir">
			</picture>

			<marquee>Toute l'information de seconde main par des procédés à l'éthique parfois discutable</marquee>

			<div class="page">
				<div id="wikipedia"><h2>Wikipedia</h2></div>
				<div id="google"><h2>Google queries</h2></div>
				<div id="bienpublic"><h2>Bien Public</h2></div>
				<div id="semur"><h2>Semur en Auxois</h2></div>
				<div id="hydro"><h2>Hydrométrie</h2>Aval barrage Pont : hauteur d'eau (mm)</div>
				<div id="lemonde"><h2>Le Monde</h2></div>
				<div id="courrier"><h2>Courrier international</h2></div>
				<div id="ign"><h2>IGN France</h2></div>
				<div id="cnet"><h2>CNET France</h2></div>
			</div>

			<script type="text/javascript">

				function getGrattoir(){
					var loadingDiv = document.getElementById('loading');

					const reqHeaders = {
						"apikey": "9455a76bb03c5a8f8305"
					};

					//const reqUrl = 'http://localhost:5000/grattoir/';
					const reqUrl = 'https://nnoi.se/api/grattoir/';
					const apiReq = new Request(reqUrl, {headers: reqHeaders});

					fetch(apiReq)
					.then(response => response.json())
					.then(data => {
						console.log(data);
						showWikipedia(data);
						showGoogle(data);
						showHydro(data);
						showRss(data, 'bienpublic', 'bien_public');
						showRss(data, 'semur', 'semur');
						showRss(data, 'lemonde', 'le_monde');
						showRss(data, 'courrier', 'courrier_int');
						showRss(data, 'ign', 'ign_france');
						showRss(data, 'cnet', 'cnet_france');
						loadingDiv.style.display = 'none';
					})
					.catch(e => {
						console.log(e);
						loadingDiv.insertAdjacentHTML('beforeend', '<br>'+e);
					});
				}

				
				function showWikipedia(data){
					var wikipediaDiv = document.getElementById('wikipedia');

					if ('error' in data.wikipedia){
						wikipediaDiv.insertAdjacentHTML('beforeend', 'API Error - ' + data.wikipedia.error);
						return
					}

					var toInsert = '<p><a href="'+data.wikipedia.url+'" target="_blank">'+data.wikipedia.title+
						'</a> - '+data.wikipedia.summary+'</p>';
					wikipediaDiv.insertAdjacentHTML('beforeend', toInsert);

				}


				function showGoogle(data){
					var googleDiv = document.getElementById('google');

					if ('error' in data.google_queries){
						googleDiv.insertAdjacentHTML('beforeend', 'API Error - ' + data.google_queries.error);
						return
					}

					var toInsert = '<p><ul>';
					for (var i=0;i<data.google_queries.length;i++){
						toInsert += '<li><a href="'+data.google_queries[i].url+'" target="_blank">'+data.google_queries[i].query+
							'</a></li>';
					}
					toInsert += '</ul></p>';
					googleDiv.insertAdjacentHTML('beforeend', toInsert);

				}


				function showHydro(data){
					var hydroDiv = document.getElementById('hydro');

					if ('error' in data.hydro_h){
						hydroDiv.insertAdjacentHTML('beforeend', 'API Error - ' + data.hydro_h.error);
						return
					}

					if ('error' in data.hydro_h.hydro_h_aval){
						hydroDiv.insertAdjacentHTML('beforeend', 'API Error - ' + data.hydro_h.hydro_h_aval.error);
						return
					}

					var X = data.hydro_h.hydro_h_aval.map(obs => obs.date_obs);
					var Y = data.hydro_h.hydro_h_aval.map(obs => obs.resultat_obs);

					var avalHPlot = {
						x: X,
						y: Y
					};

					var avalHLayout = {
						//title: 'Aval barrage Pont : hauteur d\'eau (mm)'
					};

					var plotDiv = document.createElement('div');
					hydroDiv.appendChild(plotDiv);

					Plotly.newPlot(plotDiv, [avalHPlot], avalHLayout);
				}


				function showRss(data, divId, jsonId){
					var displayDiv = document.getElementById(divId);

					if ('error' in data[jsonId]){
						displayDiv.insertAdjacentHTML('beforeend', 'API Error - ' + data[jsonId].error);
						return
					}

					var toInsert = '<p><ul>';
					for (var i=0;i<data[jsonId].length;i++){
						toInsert += '<li><a href="'+data[jsonId][i].link+'" target="_blank">'+data[jsonId][i].title+
							'</a></li>';
					}
					toInsert += '</ul></p>';
					displayDiv.insertAdjacentHTML('beforeend', toInsert);
				}


				getGrattoir();
			</script>
	</body>

</html>
