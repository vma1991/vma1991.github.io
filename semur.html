
<!doctype html>
<html lang="fr">

	<head>
		<title>vma1991.net</title>

		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		<link rel="stylesheet" href="style.css">

		<script src="https://cdn.plot.ly/plotly-2.12.1.min.js"></script>
	</head>

	<body>

		<h3>Semur</h3>

		<p>Aggr&eacute;gateur d'informations - Semur en Auxois et environs</p>

		<ul>
			<li><a href="#mairieSemur">Mairie de Semur</a></li>
			<li><a href="#bienPublic">Bien Public C&ocirc;te d'Or</a></li>
			<li><a href="#hydroPont">Lac de Pont : sondes hydrom&eacute;triques</a></li>
			<li><a href="#">Nappe phr&eacute;atique Saulieu : pi&eacute;zom&egrave;tre</a></li>
		</ul>

		<div id="divMairieSemur">
			<a id="mairieSemur"></a>
			<h2>Mairie de Semur</h2>
			<div id="divSemurMairieStatus"></div>
			<div id="divSemurMairieActu"></div>
			<div id="divSemurMairieAgenda"></div>
		</div>

		<div id="divBienPublic">
			<a id="bienPublic"></a>
			<h2>Bien Public C&ocirc;te d&apos;Or</h2>
			<div id="divBienPublicStatus"></div>
			<div id="divBienPublicActu"></div>
		</div>

		<div id="divHydroPont">
			<a id="hydroPont"></a>
			<h2>Lac de Pont : sondes hydrom&eacute;triques</h2>
			<div id="divHydroPontStatus"></div>
			<div id="divHydroPontAmontH"></div>
			<div id="divHydroPontAvalH"></div>
			<div id="divHydroPontAvalQ"></div>
		</div>

		<div id="divPiezo">
			<a id="piezo"></a>
			<h2>Nappe phr&eacute;atique Saulieu : pi&eacute;zom&egrave;tre</h2>
			<div id="divPiezoStatus"></div>
			<div id="divPiezoLevel"></div>
		</div>

		<script type="text/javascript">

			divSemurMairieStatus = document.getElementById('divSemurMairieStatus');
			divSemurMairieActu = document.getElementById('divSemurMairieActu');
			divSemurMairieAgenda = document.getElementById('divSemurMairieAgenda');

			divBienPublicStatus = document.getElementById('divBienPublicStatus');
			divBienPublicActu = document.getElementById('divBienPublicActu');

			divHydroPontStatus = document.getElementById('divHydroPontStatus');
			divHydroPontAmontH = document.getElementById('divHydroPontAmontH');
			divHydroPontAvalH = document.getElementById('divHydroPontAvalH');
			divHydroPontAvalQ = document.getElementById('divHydroPontAvalQ');

			divPiezo = document.getElementById('divPiezo');
			divPiezoStatus = document.getElementById('divPiezoStatus');
			divPiezoLevel = document.getElementById('divPiezoLevel');

			function getSemur(){

				divSemurMairieStatus.insertAdjacentHTML('beforeend', 'Loading... &#9203;');
				divBienPublicStatus.insertAdjacentHTML('beforeend', 'Loading... &#9203;');
				divHydroPontStatus.insertAdjacentHTML('beforeend', 'Loading... &#9203;');
				divPiezoStatus.insertAdjacentHTML('beforeend', 'Loading... &#9203;');

				const reqHeaders = {
					"apikey": "9455a76bb03c5a8f8305"
				};

				//const reqUrl = 'http://localhost:5000/semur/';
				const reqUrl = 'https://nnoi.se/api/semur/';
				const apiReq = new Request(reqUrl, {headers: reqHeaders});

				fetch(apiReq)
				.then(response => response.json())
				.then(data => {
					divSemurMairieStatus.replaceChildren();
					mairieSemurActu(data);
					mairieSemurAgenda(data);

					divBienPublicStatus.replaceChildren();
					bienPublic(data);

					divHydroPontStatus.replaceChildren();
					hydroHAmont(data);
					hydroHAval(data);
					hydroQAval(data);

					divPiezoStatus.replaceChildren();
					piezoH(data);
				})
				.catch(e => {
					divSemurMairieStatus.insertAdjacentHTML('beforeend', '<br>' + e);
					divBienPublicStatus.insertAdjacentHTML('beforeend', '<br>' + e);
				});
			}

			function mairieSemurActu(data){

				h3MairieSemurActu = document.createElement('h3');
				h3MairieSemurActu.innerHTML = "Actualit&eacute;s";
				divSemurMairieActu.appendChild(h3MairieSemurActu);

				if ('error' in data.mairie_semur_post){
					divSemurMairieActu.insertAdjacentHTML('beforeend', 'API Error - ' + data.mairie_semur_post.error);
					return
				}

				toInsert = '<ul>';
				for (var i = 0 ; i < data.mairie_semur_post.length ; i++){
					toInsert += '<li><a href="' + data.mairie_semur_post[i].url + '" target="_blank">'
						+ data.mairie_semur_post[i].title + '</a></li>';
				}
				toInsert += '</ul>';

				divSemurMairieActu.insertAdjacentHTML('beforeend', toInsert);

			}

			function mairieSemurAgenda(data){

				h3MairieSemurAgenda = document.createElement('h3');
				h3MairieSemurAgenda.textContent = "Agenda";
				divSemurMairieAgenda.appendChild(h3MairieSemurAgenda);

				if ('error' in data.mairie_semur_agenda){
					divSemurMairieAgenda.insertAdjacentHTML('beforeend', 'API Error - ' + data.mairie_semur_agenda.error);
					return
				}

				toInsert = '<ul>';
				for (var i = 0 ; i < data.mairie_semur_agenda.length ; i++){
					toInsert += '<li><a href="' + data.mairie_semur_agenda[i].url + '" target="_blank">'
						+ data.mairie_semur_agenda[i].title + '</a></li>';
				}
				toInsert += '</ul>';

				divSemurMairieAgenda.insertAdjacentHTML('beforeend', toInsert);

			}

			function bienPublic(data){

				if ('error' in data.bien_public){
					divBienPublicActu.insertAdjacentHTML('beforeend', 'API Error - ' + data.bien_public.error);
					return
				}

				toInsert = '<ul>';
				for (var i = 0 ; i < data.bien_public.length ; i++){
					toInsert += '<li><a href="' + data.bien_public[i].url + '" target="_blank">'
						+ data.bien_public[i].title + '</a></li>';
				}
				toInsert += '</ul>';

				divBienPublicActu.insertAdjacentHTML('beforeend', toInsert);
			}

			function hydroHAmont(data){

				if ('error' in data.hydro_h.hydro_h_amont){
					divHydroPontAmontH.insertAdjacentHTML('beforeend', 'API Error - ' + data.hydro_h.hydro_h_amont.error);
					return
				}

				X = data.hydro_h.hydro_h_amont.map(obs => obs.date_obs);
				Y = data.hydro_h.hydro_h_amont.map(obs => obs.resultat_obs);

				var amontHPlot = {
					x: X,
					y: Y
				};

				var amontHLayout = {
					title: 'Sonde amont barrage : hauteur d\'eau (mm)'
				};

				divHydroPontAmontH.style.maxWidth = '800px';
				Plotly.newPlot(divHydroPontAmontH, [amontHPlot], amontHLayout);
			}

			function hydroHAval(data){

				if ('error' in data.hydro_h.hydro_h_aval){
					divHydroPontAvalH.insertAdjacentHTML('beforeend', 'API Error - ' + data.hydro_h.hydro_h_aval.error);
					return
				}

				X = data.hydro_h.hydro_h_aval.map(obs => obs.date_obs);
				Y = data.hydro_h.hydro_h_aval.map(obs => obs.resultat_obs);

				var avalHPlot = {
					x: X,
					y: Y
				};

				var avalHLayout = {
					title: 'Sonde aval barrage : hauteur d\'eau (mm)'
				};

				divHydroPontAvalH.style.maxWidth = '800px';
				Plotly.newPlot(divHydroPontAvalH, [avalHPlot], avalHLayout);
			}

			function hydroQAval(data){

				if ('error' in data.hydro_q){
					divHydroPontAvalQ.insertAdjacentHTML('beforeend', 'API Error - ' + data.hydro_q.error);
					return
				}

				X = data.hydro_q.map(obs => obs.date_obs);
				Y = data.hydro_q.map(obs => obs.resultat_obs);

				var avalQPlot = {
					x: X,
					y: Y
				};

				var avalQLayout = {
					title: 'Sonde aval barrage : débit (l/h)'
				};

				divHydroPontAvalQ.style.maxWidth = '800px';
				Plotly.newPlot(divHydroPontAvalQ, [avalQPlot], avalQLayout);
			}

			function piezoH(data){

				if ('error' in data.nappe_piezo){
					divPiezoLevel.insertAdjacentHTML('beforeend', 'API Error - ' + data.nappe_piezo.error);
					return
				}

				X = data.nappe_piezo.map(obs => obs.date_mesure);
				Y = data.nappe_piezo.map(obs => obs.profondeur_nappe);

				var piezoPlot = {
					x: X,
					y: Y
				};

				var piezoLayout = {
					title: 'Nappe phréatique socle du Morvan (Saulieu) : distance entre sol et surface de l\'eau',
					yaxis: {autorange: 'reversed'}
				};

				divPiezoLevel.style.maxWidth = '800px';
				Plotly.newPlot(divPiezoLevel, [piezoPlot], piezoLayout);
			}

			getSemur();
			
		</script>
		
	</body>

</html>
